#!/bin/sh
#
# Keyboard layout toggle script for mangowc
#
# USAGE:
#   layouttoggle        - Cycle: ca -> us -> coolmak -> ca
#   layouttoggle us     - Force set to US layout
#   layouttoggle ca     - Force set to Canadian layout (with Ã©)
#   layouttoggle coolmak - Force set to Coolmak layout
#

cachefile="$HOME/.cache/layout"

# Handle manual override
if [ -n "$1" ]; then
    case "$1" in
        ca|us|coolmak)
            mmsg -d setoption,xkb_rules_layout,"$1"
            echo "$1" > "$cachefile"
            ;;
        *)
            echo "Invalid layout: $1"
            exit 1
            ;;
    esac
else
    # Get current layout from mangowc
    current_layout=$(mmsg -g | grep "kb_layout" | head -1 | awk '{print $3}')

    # Cycle through layouts: ca -> us -> coolmak -> ca
    case "$current_layout" in
        ca)
            mmsg -d setoption,xkb_rules_layout,us
            echo "us" > "$cachefile"
            ;;
        us)
            mmsg -d setoption,xkb_rules_layout,coolmak
            echo "coolmak" > "$cachefile"
            ;;
        coolmak|eng)
            # mangowc might show coolmak as "eng"
            mmsg -d setoption,xkb_rules_layout,ca
            echo "ca" > "$cachefile"
            ;;
        *)
            # Default to ca if unknown
            mmsg -d setoption,xkb_rules_layout,ca
            echo "ca" > "$cachefile"
            ;;
    esac
fi

# Restart waybar if running
waybar_pid=$(pidof waybar)
if [ -n "$waybar_pid" ]; then
    kill -38 "$waybar_pid" 2>/dev/null || true
fi
